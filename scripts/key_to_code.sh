#!/usr/bin/env zsh
set -euo pipefail
IFS=$'\n\t'

typeset -A ydotool_keymap

# https://pickpj.github.io/keycodes.html
# sudo libinput record --show-keycodes
case "$(swaymsg -t get_inputs |\
    jq -r '.[]|select(.type=="keyboard" and .name=="ydotoold virtual device") |"\(.xkb_active_layout_name)"' |\
    tr '[:upper:]' '[:lower:]')" in
    *german*)

    ydotool_keymap['']='1:1 1:0'
    ydotool_keymap['<ESC>']='1:1 1:0'
    ydotool_keymap['']='14:1 14:0'
    ydotool_keymap['<BS>']='14:1 14:0'
    ydotool_keymap['	']='15:1 15:0'
    ydotool_keymap['<Tab>']='15:1 15:0'
    ydotool_keymap['']='28:1 28:0'
    ydotool_keymap['<Ret>']='28:1 28:0'
    ydotool_keymap['<C>']='29:1 29:0'
    ydotool_keymap['<Cl>']='29:1 29:0'
    ydotool_keymap['<S>']='42:1 42:0'
    ydotool_keymap['<Sl>']='42:1 42:0'
    ydotool_keymap['<Sr>']='54:1 54:0'
    ydotool_keymap['<K*>']='55:1 55:0'
    ydotool_keymap['<A>']='56:1 56:0'
    ydotool_keymap['<Al>']='56:1 56:0'
    ydotool_keymap['<CapsLock>']='58:1 58:0'
    ydotool_keymap['<NumLock>']='69:1 69:0'
    ydotool_keymap['<Scroll>']='70:1 70:0'
    ydotool_keymap['<Cr>']='97:1 97:0'
    ydotool_keymap['<Ar>']='100:1 100:0'
    ydotool_keymap['<AGr>']='100:1 100:0'
    ydotool_keymap['<Super>']='125:1 125:0'
    ydotool_keymap['<Superl>']='125:1 125:0'
    ydotool_keymap['<Superr>']='125:1 125:0'
    ydotool_keymap['<ContextMenu>']='126:1 126:0'
    ydotool_keymap['<Compose>']='126:1 126:0'

    ${samelength-false} && d="delay delay " || d=

    ydotool_keymap['1']="$d"'2:1 2:0'
    ydotool_keymap['2']="$d"'3:1 3:0'
    ydotool_keymap['3']="$d"'4:1 4:0'
    ydotool_keymap['4']="$d"'5:1 5:0'
    ydotool_keymap['5']="$d"'6:1 6:0'
    ydotool_keymap['6']="$d"'7:1 7:0'
    ydotool_keymap['7']="$d"'8:1 8:0'
    ydotool_keymap['8']="$d"'9:1 9:0'
    ydotool_keymap['9']="$d"'10:1 10:0'
    ydotool_keymap['0']="$d"'11:1 11:0'
    ydotool_keymap['√ü']="$d"'12:1 12:0'
    ydotool_keymap['¬¥']="$d"'13:1 13:0'
    ydotool_keymap['q']="$d"'16:1 16:0'
    ydotool_keymap['w']="$d"'17:1 17:0'
    ydotool_keymap['e']="$d"'18:1 18:0'
    ydotool_keymap['r']="$d"'19:1 19:0'
    ydotool_keymap['t']="$d"'20:1 20:0'
    ydotool_keymap['z']="$d"'21:1 21:0'
    ydotool_keymap['u']="$d"'22:1 22:0'
    ydotool_keymap['i']="$d"'23:1 23:0'
    ydotool_keymap['o']="$d"'24:1 24:0'
    ydotool_keymap['p']="$d"'25:1 25:0'
    ydotool_keymap['√º']="$d"'26:1 26:0'
    ydotool_keymap['+']="$d"'27:1 27:0'
    ydotool_keymap['a']="$d"'30:1 30:0'
    ydotool_keymap['s']="$d"'31:1 31:0'
    ydotool_keymap['d']="$d"'32:1 32:0'
    ydotool_keymap['f']="$d"'33:1 33:0'
    ydotool_keymap['g']="$d"'34:1 34:0'
    ydotool_keymap['h']="$d"'35:1 35:0'
    ydotool_keymap['j']="$d"'36:1 36:0'
    ydotool_keymap['k']="$d"'37:1 37:0'
    ydotool_keymap['l']="$d"'38:1 38:0'
    ydotool_keymap['√∂']="$d"'39:1 39:0'
    ydotool_keymap['√§']="$d"'40:1 40:0'
    ydotool_keymap['^']="$d"'41:1 41:0'
    ydotool_keymap['#']="$d"'43:1 43:0'
    ydotool_keymap['y']="$d"'44:1 44:0'
    ydotool_keymap['x']="$d"'45:1 45:0'
    ydotool_keymap['c']="$d"'46:1 46:0'
    ydotool_keymap['v']="$d"'47:1 47:0'
    ydotool_keymap['b']="$d"'48:1 48:0'
    ydotool_keymap['n']="$d"'49:1 49:0'
    ydotool_keymap['m']="$d"'50:1 50:0'
    ydotool_keymap[',']="$d"'51:1 51:0'
    ydotool_keymap['.']="$d"'52:1 52:0'
    ydotool_keymap['-']="$d"'53:1 53:0'
    ydotool_keymap[' ']="$d"'57:1 57:0'
    ydotool_keymap['<F1>']='59:1 59:0'
    ydotool_keymap['<F2>']='60:1 60:0'
    ydotool_keymap['<F3>']='61:1 61:0'
    ydotool_keymap['<F4>']='62:1 62:0'
    ydotool_keymap['<F5>']='63:1 63:0'
    ydotool_keymap['<F6>']='64:1 64:0'
    ydotool_keymap['<F7>']='65:1 65:0'
    ydotool_keymap['<F8>']='66:1 66:0'
    ydotool_keymap['<F9>']='67:1 67:0'
    ydotool_keymap['<F10>']='68:1 68:0'
    ydotool_keymap['<K7>']="$d"'71:1 71:0'
    ydotool_keymap['<K8>']="$d"'72:1 72:0'
    ydotool_keymap['<K9>']="$d"'73:1 73:0'
    ydotool_keymap['<K->']="$d"'74:1 74:0'
    ydotool_keymap['<K4>']="$d"'75:1 75:0'
    ydotool_keymap['<K5>']="$d"'76:1 76:0'
    ydotool_keymap['<K6>']="$d"'77:1 77:0'
    ydotool_keymap['<K+>']="$d"'78:1 78:0'
    ydotool_keymap['<K1>']="$d"'79:1 79:0'
    ydotool_keymap['<K2>']="$d"'80:1 80:0'
    ydotool_keymap['<K3>']="$d"'81:1 81:0'
    ydotool_keymap['<K0>']="$d"'82:1 82:0'
    ydotool_keymap['<K.>']="$d"'83:1 83:0'
    ydotool_keymap['<']="$d"'86:1 86:0'
    ydotool_keymap['<F11>']='87:1 87:0'
    ydotool_keymap['<F12>']='88:1 88:0'
    ydotool_keymap['<KRet>']='96:1 96:0'
    ydotool_keymap['<K/>']='98:1 98:0'
    ydotool_keymap['<Prt>']='99:1 99:0'
    ydotool_keymap['<Sys>']='99:1 99:0'
    ydotool_keymap['<Home>']='102:1 102:0'
    ydotool_keymap['<Up>']='103:1 103:0'
    ydotool_keymap['‚Üë']='103:1 103:0'
    ydotool_keymap['<PgUp>']='104:1 104:0'
    ydotool_keymap['<Left>']='105:1 105:0'
    ydotool_keymap['‚Üê']='105:1 105:0'
    ydotool_keymap['<Right>']='106:1 106:0'
    ydotool_keymap['‚Üí']='106:1 106:0'
    ydotool_keymap['<End>']='107:1 107:0'
    ydotool_keymap['<Down>']='108:1 108:0'
    ydotool_keymap['‚Üì']='108:1 108:0'
    ydotool_keymap['<PgDown>']='109:1 109:0'
    ydotool_keymap['<Insert>']='110:1 110:0'
    ydotool_keymap['<Delete>']='111:1 111:0'
    ydotool_keymap['<Mute>']='113:1 113:0'
    ydotool_keymap['<VolUp>']='114:1 114:0'
    ydotool_keymap['<VolDown>']='115:1 115:0'
    ydotool_keymap['<Power>']='116:1 116:0'
    ydotool_keymap['<K=>']='117:1 117:0'
    ydotool_keymap['<K¬±>']='118:1 118:0'
    ydotool_keymap['<Pause>']='119:1 119:0'
    ydotool_keymap['<K.>']='121:1 121:0'
    # Shift
    ydotool_keymap['¬∞']='42:1 41:1 41:0 42:0'
    ydotool_keymap['!']='42:1 2:1 2:0 42:0'
    ydotool_keymap['"']='42:1 3:1 3:0 42:0'
    ydotool_keymap['¬ß']='42:1 4:1 4:0 42:0'
    ydotool_keymap['$']='42:1 5:1 5:0 42:0'
    ydotool_keymap['%']='42:1 6:1 6:0 42:0'
    ydotool_keymap['&']='42:1 7:1 7:0 42:0'
    ydotool_keymap['/']='42:1 8:1 8:0 42:0'
    ydotool_keymap['(']='42:1 9:1 9:0 42:0'
    ydotool_keymap[')']='42:1 10:1 10:0 42:0'
    ydotool_keymap['=']='42:1 11:1 11:0 42:0'
    ydotool_keymap['?']='42:1 12:1 12:0 42:0'
    ydotool_keymap['`']='42:1 13:1 13:0 42:0'
    ydotool_keymap['Q']='42:1 16:1 16:0 42:0'
    ydotool_keymap['W']='42:1 17:1 17:0 42:0'
    ydotool_keymap['E']='42:1 18:1 18:0 42:0'
    ydotool_keymap['R']='42:1 19:1 19:0 42:0'
    ydotool_keymap['T']='42:1 20:1 20:0 42:0'
    ydotool_keymap['Z']='42:1 21:1 21:0 42:0'
    ydotool_keymap['U']='42:1 22:1 22:0 42:0'
    ydotool_keymap['I']='42:1 23:1 23:0 42:0'
    ydotool_keymap['O']='42:1 24:1 24:0 42:0'
    ydotool_keymap['P']='42:1 25:1 25:0 42:0'
    ydotool_keymap['√ú']='42:1 26:1 26:0 42:0'
    ydotool_keymap['*']='42:1 27:1 27:0 42:0'
    ydotool_keymap['A']='42:1 30:1 30:0 42:0'
    ydotool_keymap['S']='42:1 31:1 31:0 42:0'
    ydotool_keymap['D']='42:1 32:1 32:0 42:0'
    ydotool_keymap['F']='42:1 33:1 33:0 42:0'
    ydotool_keymap['G']='42:1 34:1 34:0 42:0'
    ydotool_keymap['H']='42:1 35:1 35:0 42:0'
    ydotool_keymap['J']='42:1 36:1 36:0 42:0'
    ydotool_keymap['K']='42:1 37:1 37:0 42:0'
    ydotool_keymap['L']='42:1 38:1 38:0 42:0'
    ydotool_keymap['√ñ']='42:1 39:1 39:0 42:0'
    ydotool_keymap['√Ñ']='42:1 40:1 40:0 42:0'
    ydotool_keymap["'"]='42:1 43:1 43:0 42:0'
    ydotool_keymap['Y']='42:1 44:1 44:0 42:0'
    ydotool_keymap['X']='42:1 45:1 45:0 42:0'
    ydotool_keymap['C']='42:1 46:1 46:0 42:0'
    ydotool_keymap['V']='42:1 47:1 47:0 42:0'
    ydotool_keymap['B']='42:1 48:1 48:0 42:0'
    ydotool_keymap['N']='42:1 49:1 49:0 42:0'
    ydotool_keymap['M']='42:1 50:1 50:0 42:0'
    ydotool_keymap[';']='42:1 51:1 51:0 42:0'
    ydotool_keymap[':']='42:1 52:1 52:0 42:0'
    ydotool_keymap['_']='42:1 53:1 53:0 42:0'
    ydotool_keymap['>']='42:1 86:1 86:0 42:0'
    # Alt Gr
    ydotool_keymap['¬π']='100:1 2:1 2:0 100:0'
    ydotool_keymap['¬≤']='100:1 3:1 3:0 100:0'
    ydotool_keymap['¬≥']='100:1 4:1 4:0 100:0'
    ydotool_keymap['¬º']='100:1 5:1 5:0 100:0'
    ydotool_keymap['¬Ω']='100:1 6:1 6:0 100:0'
    ydotool_keymap['¬¨']='100:1 7:1 7:0 100:0'
    ydotool_keymap['{']='100:1 8:1 8:0 100:0'
    ydotool_keymap['[']='100:1 9:1 9:0 100:0'
    ydotool_keymap[']']='100:1 10:1 10:0 100:0'
    ydotool_keymap['}']='100:1 11:1 11:0 100:0'
    ydotool_keymap['\']='100:1 12:1 12:0 100:0'
    ydotool_keymap['¬∏']='100:1 13:1 13:0 100:0'
    ydotool_keymap['@']='100:1 16:1 16:0 100:0'
    ydotool_keymap['≈ø']='100:1 17:1 17:0 100:0'
    ydotool_keymap['‚Ç¨']='100:1 18:1 18:0 100:0'
    ydotool_keymap['¬∂']='100:1 19:1 19:0 100:0'
    ydotool_keymap['≈ß']='100:1 20:1 20:0 100:0'
    ydotool_keymap['<‚Üê>']='100:1 21:1 21:0 100:0'
    ydotool_keymap['<‚Üì>']='100:1 22:1 22:0 100:0'
    ydotool_keymap['<‚Üí>']='100:1 23:1 23:0 100:0'
    ydotool_keymap['√∏']='100:1 24:1 24:0 100:0'
    ydotool_keymap['√æ']='100:1 25:1 25:0 100:0'
    ydotool_keymap['¬®']='100:1 26:1 26:0 100:0'
    ydotool_keymap['~']='100:1 27:1 27:0 100:0'
    ydotool_keymap['√¶']='100:1 30:1 30:0 100:0'
    ydotool_keymap['≈ø']='100:1 31:1 31:0 100:0'
    ydotool_keymap['√∞']='100:1 32:1 32:0 100:0'
    ydotool_keymap['ƒë']='100:1 33:1 33:0 100:0'
    ydotool_keymap['≈ã']='100:1 34:1 34:0 100:0'
    ydotool_keymap['ƒß']='100:1 35:1 35:0 100:0'
    ydotool_keymap['ƒ∏']='100:1 37:1 37:0 100:0'
    ydotool_keymap['≈Ç']='100:1 38:1 38:0 100:0'
    ydotool_keymap['Àù']='100:1 39:1 39:0 100:0'
    ydotool_keymap['‚Äô']='100:1 43:1 43:0 100:0'
    ydotool_keymap['¬ª']='100:1 44:1 44:0 100:0'
    ydotool_keymap['¬´']='100:1 45:1 45:0 100:0'
    ydotool_keymap['¬¢']='100:1 46:1 46:0 100:0'
    ydotool_keymap['‚Äú']='100:1 48:1 48:0 100:0'
    ydotool_keymap['‚Äù']='100:1 49:1 49:0 100:0'
    ydotool_keymap['¬µ']='100:1 50:1 50:0 100:0'
    ydotool_keymap['¬∑']='100:1 51:1 51:0 100:0'
    ydotool_keymap['‚Ä¶']='100:1 52:1 52:0 100:0'
    ydotool_keymap['‚Äì']='100:1 53:1 53:0 100:0'
    ydotool_keymap['|']='100:1 86:1 86:0 100:0'
    # Shift+Alt Gr
    ydotool_keymap['¬°']='42:1 100:1 2:1 2:0 100:0 42:0'
    ydotool_keymap['‚Öõ']='42:1 100:1 3:1 3:0 100:0 42:0'
    ydotool_keymap['¬£']='42:1 100:1 4:1 4:0 100:0 42:0'
    ydotool_keymap['¬§']='42:1 100:1 5:1 5:0 100:0 42:0'
    ydotool_keymap['‚Öú']='42:1 100:1 6:1 6:0 100:0 42:0'
    ydotool_keymap['‚Öù']='42:1 100:1 7:1 7:0 100:0 42:0'
    ydotool_keymap['‚Öû']='42:1 100:1 8:1 8:0 100:0 42:0'
    ydotool_keymap['‚Ñ¢']='42:1 100:1 9:1 9:0 100:0 42:0'
    ydotool_keymap['¬±']='42:1 100:1 10:1 10:0 100:0 42:0'
    ydotool_keymap['¬∞']='42:1 100:1 11:1 11:0 100:0 42:0'
    ydotool_keymap['¬ø']='42:1 100:1 12:1 12:0 100:0 42:0'
    ydotool_keymap['Àõ']='42:1 100:1 13:1 13:0 100:0 42:0'
    ydotool_keymap['Œ©']='42:1 100:1 16:1 16:0 100:0 42:0'
    ydotool_keymap['¬Æ']='42:1 100:1 19:1 19:0 100:0 42:0'
    ydotool_keymap['≈¶']='42:1 100:1 20:1 20:0 100:0 42:0'
    ydotool_keymap['¬•']='42:1 100:1 21:1 21:0 100:0 42:0'
    ydotool_keymap['<‚Üë>']='42:1 100:1 22:1 22:0 100:0 42:0'
    ydotool_keymap['ƒ±']='42:1 100:1 23:1 23:0 100:0 42:0'
    ydotool_keymap['√ò']='42:1 100:1 24:1 24:0 100:0 42:0'
    ydotool_keymap['√û']='42:1 100:1 25:1 25:0 100:0 42:0'
    ydotool_keymap['¬∞']='42:1 100:1 26:1 26:0 100:0 42:0'
    ydotool_keymap['¬Ø']='42:1 100:1 27:1 27:0 100:0 42:0'
    ydotool_keymap['√Ü']='42:1 100:1 30:1 30:0 100:0 42:0'
    ydotool_keymap['·∫û']='42:1 100:1 31:1 31:0 100:0 42:0'
    ydotool_keymap['¬™']='42:1 100:1 33:1 33:0 100:0 42:0'
    ydotool_keymap['≈ä']='42:1 100:1 34:1 34:0 100:0 42:0'
    ydotool_keymap['ƒ¶']='42:1 100:1 35:1 35:0 100:0 42:0'
    ydotool_keymap['Àô']='42:1 100:1 36:1 36:0 100:0 42:0'
    ydotool_keymap['≈Å']='42:1 100:1 38:1 38:0 100:0 42:0'
    ydotool_keymap['Àá']='42:1 100:1 40:1 40:0 100:0 42:0'
    ydotool_keymap['‚Ä∫']='42:1 100:1 44:1 44:0 100:0 42:0'
    ydotool_keymap['‚Äπ']='42:1 100:1 45:1 45:0 100:0 42:0'
    ydotool_keymap['¬©']='42:1 100:1 46:1 46:0 100:0 42:0'
    ydotool_keymap['‚Äö']='42:1 100:1 47:1 47:0 100:0 42:0'
    ydotool_keymap['‚Äò']='42:1 100:1 48:1 48:0 100:0 42:0'
    ydotool_keymap['‚Äô']='42:1 100:1 49:1 49:0 100:0 42:0'
    ydotool_keymap['¬∫']='42:1 100:1 50:1 50:0 100:0 42:0'
    ydotool_keymap['√ó']='42:1 100:1 51:1 51:0 100:0 42:0'
    ydotool_keymap['√∑']='42:1 100:1 52:1 52:0 100:0 42:0'
    ydotool_keymap['‚Äî']='42:1 100:1 53:1 53:0 100:0 42:0'
        ;;
    *)
        echo "Unsupported layout!" >&2
esac


stdin_to_ydotool_codes() {
    grep -o . | while read -r c; do printf '%s ' "${ydotool_keymap["$c"]}"
done
}
multi_key_ydotool() {
    for keys in "$@"; do
        local code= codesl='' codesr=''
        while read -r key; do
            code="${ydotool_keymap["$key"]}"
            codesr="${code##*:1}$codesr"
            codesl="$codesl${code%:1*}:1 "
        done < <(sed 's/\(.\)+/\1\n/' <<< "$keys")
        printf '%s%s ' "$codesl" "$codesr"
    done
}
